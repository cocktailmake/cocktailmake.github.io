<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Transmit technology information from developers.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cocktail-Make Developer Blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://cocktailmake.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/batch-generation-of-font-preview-images-with-multicore-processing/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://cocktailmake.github.io/">

                <span id="blog-title">Cocktail-Make Developer Blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/batch-generation-of-font-preview-images-with-multicore-processing/" class="u-url">Batch generation of font preview images with multicore processing</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cocktail-Make
            </span></p>
            <p class="dateline">
            <a href="posts/batch-generation-of-font-preview-images-with-multicore-processing/" rel="bookmark">
            <time class="published dt-published" datetime="2020-06-21T22:22:13+09:00" itemprop="datePublished" title="2020-06-21 22:22">2020-06-21 22:22</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>
Posted by Hitoshi Uchida
</p>

<div id="outline-container-org554ff25" class="outline-2">
<h2 id="org554ff25">Abstract</h2>
<div class="outline-text-2" id="text-org554ff25">
<p>
Our video generation service RICHKA enables users to customize
image/video materials and texts, fonts, BGM, color schemes and the
latter video generations are run with the configurations.
</p>

<p>
In this post, we introduce a background processing of the font
customizing feature, especially auto generation of preview font images
actually rendered by the underlying font engine with font files
installed on the OS with multi-core processing. If the number of the
fonts is few around 10, it is possible to manually create them with
taking screenshots and cropping desired areas and save as image
file. However, our video servers have over 1000 fonts and it is still
increasing and difficult to do by hand. To resolve such cases, a batch
processing helps us, but high speed techniques become also important.
</p>

<p>
The generated preview images are actually shown on the GUI below and
users can visually select desired fonts used for the video
generation. The whole source code is also introduced and with
utilizing some convenient Linux commands as this script, we can
implement in short time.
</p>

<p width="1500px">
<img src="images/batch-generation-of-font-preview-images-with-multicore-processing/gui-sample.png" alt="nil"></p>
</div>
</div>

<div id="outline-container-org4526bdd" class="outline-2">
<h2 id="org4526bdd">Multi-core processing</h2>
<div class="outline-text-2" id="text-org4526bdd">
<p>
On RICHKA video servers, the number of installed fonts are over 1000
and it takes much time to execute with sequential batch processing to
generate the font preview images. However, we can shorten the heavy
processing with applying multi-core processing to generate them in
parallel because each processing is independent each other and it is
general to have multi-core CPU these days.
</p>

<p>
The multi-core processing is easy thanks to Python3 builtin package
<b>multiprocessing</b>. The excerpt of a sample program below is to call
<b>gen_preview_image</b> with multi-core CPU. When it has prepared 100 data
sets, they are executed in parallel. In this example, the max number
of the used CPU core at a time is 1 less number than the number of
CPU cores. The result values returned from the function
gen_preview_image are accumulated and we can get all of the results as
well.
</p>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_multicore</span><span class="p">(</span><span class="n">func_ptr</span><span class="p">,</span> <span class="n">dset</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">multi</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># max number of processes</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">func_ptr</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="n">fontdir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># init</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
	<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

    <span class="n">fontfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fontdir</span> <span class="o">+</span> <span class="s2">"**/*.*"</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>

    <span class="n">dset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fontfile</span> <span class="ow">in</span> <span class="n">fontfiles</span><span class="p">:</span>
	<span class="n">dset</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fontfile</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="p">))</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
	    <span class="n">res</span> <span class="o">=</span> <span class="n">process_multicore</span><span class="p">(</span><span class="n">gen_preview_image</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
	    <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
	    <span class="n">dset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">):</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">process_multicore</span><span class="p">(</span><span class="n">gen_preview_image</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
	<span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">fontDirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">'/usr/share/fonts/'</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fontDir</span> <span class="ow">in</span> <span class="n">fontDirs</span><span class="p">:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">run_all</span><span class="p">(</span><span class="n">fontDir</span><span class="p">,</span> <span class="n">f</span><span class="s1">'/home/{getpass.getuser()}/tmp/font_images/'</span><span class="p">)</span>
	<span class="n">results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">result</span>
    <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-org8e2d11f" class="outline-2">
<h2 id="org8e2d11f">Sample program</h2>
<div class="outline-text-2" id="text-org8e2d11f">
<p>
The whole source code is below and we use <b>convert</b> command of
<a href="https://imagemagick.org/index.php">ImageMagic</a> to generate font preview images. The images are actually
rendered by a font engine of the OS such as <a href="https://www.freetype.org/">FreeType</a>.  The rendered
characters are 'あいうえおアイウエオABCDabcd' in default including
Japanese, but some of fonts don't have the Japanese griph data,
then 'ABCDEFGabcdefg' is rendered as fallback.
</p>

<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">fontTools</span> <span class="kn">import</span> <span class="n">ttLib</span>

<span class="k">def</span> <span class="nf">shortName</span><span class="p">(</span><span class="n">font</span><span class="p">):</span>
    <span class="sd">"""Get the short name from the font's names table"""</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">font</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
	<span class="k">if</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
	    <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16-be'</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="n">name</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="s1">'surrogateescape'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span>

<span class="k">def</span> <span class="nf">gen_preview_image</span><span class="p">(</span><span class="n">fontfile</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pointsize</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">'あいうえおアイウエオABCDabcd'</span><span class="p">,</span> <span class="n">ascii_text</span><span class="o">=</span><span class="s1">'ABCDEFGabcdefg'</span><span class="p">,</span> <span class="n">fname_prefix</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
	<span class="n">ttf</span> <span class="o">=</span> <span class="n">ttLib</span><span class="o">.</span><span class="n">TTFont</span><span class="p">(</span><span class="n">fontfile</span><span class="p">,</span> <span class="n">fontNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># https://github.com/fonttools/fonttools/issues/541</span>
	<span class="n">font_name</span> <span class="o">=</span> <span class="n">shortName</span><span class="p">(</span><span class="n">ttf</span><span class="p">)</span>
	<span class="n">fname_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">fname_prefix</span> <span class="o">+</span> <span class="n">font_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.png'</span><span class="p">)</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"convert -font '{fontfile}' -pointsize {pointsize} label:{text} '{fname_out}'"</span>
	<span class="n">cmd_in</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="s1">'surrogateescape'</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">is_overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname_out</span><span class="p">):</span>
	    <span class="k">try</span><span class="p">:</span>
		<span class="n">cmd_out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span>
	    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">grepexc</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"error and try only with ascii:"</span><span class="p">,</span> <span class="n">grepexc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">grepexc</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">fontfile</span><span class="p">)</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'convert -font {fontfile} -pointsize {pointsize} label:{ascii_text} {fname_out}'</span>
		<span class="n">cmd_in</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="s1">'surrogateescape'</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
		    <span class="n">cmd_out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="n">cmd_in</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">grepexc</span><span class="p">:</span>
		    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"error :"</span><span class="p">,</span> <span class="n">grepexc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">grepexc</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">fontfile</span><span class="p">)</span>
		    <span class="n">fname_out</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span> <span class="p">{</span><span class="s1">'preview_image_path'</span><span class="p">:</span> <span class="n">fname_out</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span> <span class="n">font_name</span><span class="p">,</span> <span class="s1">'path_font'</span><span class="p">:</span> <span class="n">fontfile</span><span class="p">}</span>
    <span class="k">except</span> <span class="n">ttLib</span><span class="o">.</span><span class="n">TTLibError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
	<span class="k">return</span> <span class="p">{</span><span class="s1">'preview_image_path'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span> <span class="s1">'UNKNOWN'</span><span class="p">,</span> <span class="s1">'path_font'</span><span class="p">:</span> <span class="n">fontfile</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">process_multicore</span><span class="p">(</span><span class="n">func_ptr</span><span class="p">,</span> <span class="n">dset</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">multi</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># max number of processes</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">func_ptr</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="n">fontdir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># init</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
	<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

    <span class="n">fontfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fontdir</span> <span class="o">+</span> <span class="s2">"**/*.*"</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>

    <span class="n">dset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fontfile</span> <span class="ow">in</span> <span class="n">fontfiles</span><span class="p">:</span>
	<span class="n">dset</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fontfile</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="p">))</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
	    <span class="n">res</span> <span class="o">=</span> <span class="n">process_multicore</span><span class="p">(</span><span class="n">gen_preview_image</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
	    <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
	    <span class="n">dset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">):</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">process_multicore</span><span class="p">(</span><span class="n">gen_preview_image</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
	<span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">fontDirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">'/usr/share/fonts/'</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fontDir</span> <span class="ow">in</span> <span class="n">fontDirs</span><span class="p">:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">run_all</span><span class="p">(</span><span class="n">fontDir</span><span class="p">,</span> <span class="n">f</span><span class="s1">'/home/{getpass.getuser()}/tmp/font_images/'</span><span class="p">)</span>
	<span class="n">results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">+</span> <span class="n">result</span>
    <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-org8d5fefc" class="outline-2">
<h2 id="org8d5fefc">Sample of generated preview images</h2>
<div class="outline-text-2" id="text-org8d5fefc">
<p>
It took a few minutes to have generated the preview images with over
1000 fonts and the sample ones are below.  The processing speed is
enough and we can utilize the max of the CPU resources.
</p>

<p width="1500px">
<img src="images/batch-generation-of-font-preview-images-with-multicore-processing/sample-result.png" alt="nil"></p>
</div>
</div>

<div id="outline-container-org5542689" class="outline-2">
<h2 id="org5542689">Conclusion</h2>
<div class="outline-text-2" id="text-org5542689">
<p>
We introduced a practical sample program to execute a batch processing
to generate font preview images with over 1000 fonts with utilizing
multi-core CPU. Though we omitted in the sample code, our video
servers stores the generated preview images into S3 and they are
actually shown on RICHKA GUI and it helps users to visually select
desired fonts used for video generation.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/progress-display-of-video-generation/" class="u-url">Realtime Display of Video Generation Progress</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cocktail-Make
            </span></p>
            <p class="dateline">
            <a href="posts/progress-display-of-video-generation/" rel="bookmark">
            <time class="published dt-published" datetime="2020-05-16T18:07:20+09:00" itemprop="datePublished" title="2020-05-16 18:07">2020-05-16 18:07</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>
Posted by Hitoshi Uchida
</p>

<div id="outline-container-org81bc0d6" class="outline-2">
<h2 id="org81bc0d6">Abstract</h2>
<div class="outline-text-2" id="text-org81bc0d6">
<p>
The video generation in RICHKA is to serialize high quality videos on
video servers with using video templates designed by export
designers. The processing is heavy load and takes several minutes,
therefore RICHKA has a dedicated GUI feature to show the progress
ratio in realtime so that users can check the remained waiting
time. During the processing, video servers monitor the detail
progresses and transmit to web servers to feedback to users on GUI.
</p>

<p>
RICHKA uses HTTP streaming for the realtime transmitting of the
progress ratio among servers. This feature is to continue send
application data little by little formatted with HTTP chunked
encoding. During sending them, the TCP connection is kept to open. The
HTTP streaming is available on general high-level web server
frameworks as well and we are ready to apply to product services
without taking care the underlying protocol format by
ourselves. However, we need to understand the restriction that the
HTTP connection is per URL. The restriction is simple, but we
sometimes encounter difficulties on practical service products.
</p>

<p>
In the case of RICHKA, when users click a button to generate videos on
editing pages, it redirects users to top page to see the progress
ration on the video list so that users can edit other videos during
generation videos. Then, the TCP connection between web browsers and
web servers are disconnected in redirecting because of the restriction
and the progress reporting from video servers don't reach to web
browsers. To enable to show the realtime progress after HTTP
redirecting, RICHKA has a dedicated server side processing and this
post explains how RICHKA does. There are several alternatives to
realize this feature, but RICHKA doesn't depend on additional external
services and the internal architecture is also simple and straight
forward. I think this architecture could be applied to general use
cases and I hope this post provides some hints to readers of this
blog.
</p>
</div>
</div>

<div id="outline-container-orge81175d" class="outline-2">
<h2 id="orge81175d">Technical Restriction of HTTP streaming</h2>
<div class="outline-text-2" id="text-orge81175d">
<p width="1500px">
<img src="images/progress-display-of-video-generation/restriction.png" alt="nil"></p>

<p>
The figure above represents the detail procedure how the progress reporting
with the HTTP streaming is blocked. The bottom is the GUI of RICHKA
and the left side is the editing page to input user data and the right
side is the top page listing up users' videos. The blue arrow
represents the HTTP redirect to navigate users to a top page and it is
triggered when users click the button of video generation on the
editing pages. In the timing, the HTTP streaming response from web
servers are disconnected and the top page can't get the further
progress ratio. The detail procedure in the figure is below.
</p>

<ol class="org-ol">
<li>On edit pages, when users click a button to generate videos, it sends a HTTP request with XMLHttpRequest to one of web serves via load balancer. Then the browser is redirect to the top page listing video data.</li>
<li>The Web server delegates the video generation to one of video servers with sending a HTTP request again. The video server loads a video template and start to generate a video</li>
<li>During generating, the video server sends the progress ratio with HTTP chunked encoding whose application data is JSON format to the web server.</li>
<li>The web server transfers the progress ratio received from the video server, but the TCP connection with the web browser has been already disconnected and the data can't reach it.</li>
</ol>
<p>
For a reference, the chunked transfer encoding is like this. In
general, CGI scripts response with using it. Content-Length header is
not used because the expected data size is not known beforehand. A
chunked data starts with the payload size and it ends with a line
break CR LF. In the final chunk, we need to send an empty chunked data
to notify it is last one to the receiver. In RICHKA, the application
data is the progress ratio formatted with JSON.
</p>

<div class="highlight"><pre><span></span>HTTP/1.1 200 OK
Content-Type: text/plain
Transfer-Encoding: chunked

5\r\n
Hello\r\n
6\r\n
RICHKA\r\n
0\r\n
\r\n
</pre></div>
</div>
</div>


<div id="outline-container-org76c9e1f" class="outline-2">
<h2 id="org76c9e1f">Realtime Display of Video Generation Progress after HTTP Redirect</h2>
<div class="outline-text-2" id="text-org76c9e1f">
<p width="1500px">
<img src="images/progress-display-of-video-generation/solution.png" alt="nil"></p>

<p>
To resolve this restriction deriving from the HTTP connection per URL,
RICHKA realizes the realtime feedback of progress ratio with the
architecture above for the specific case of redirecting. The detail procedure is below.
</p>

<ol class="org-ol">
<li>ditto with the prior section</li>
<li>The web server forks a dedicated process to communicate with the video server. It sends a HTTP request and delegates the video generation. In this timing, the TCP connection is disconnected with the web browser because of the redirection.</li>
<li>The forked process is still alive and it continues to receive the progress ratio from video serves with HTTP chunked encoding.</li>
<li>Every when the forked process receives the progress ratio, it saves into database as the progress data for the video data.</li>
<li>After redirecting, the top page periodically sends HTTP GET request to the web server and show the progress data on GUI.</li>
</ol>
<p>
At the last step, there is alternative method with WebSocket protocol,
but RICHKA doesn't use because general users access from their company
offices and it is general their networks apply HTTP
proxies. Unfortunately, some of HTTP proxies block WebSocket
connection to enhance the web security. Therefore, RICHKA
intentionally applies the traditional method to make more stable.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/big-picture-of-richka/" class="u-url">Big picture of RICHKA</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cocktail-Make
            </span></p>
            <p class="dateline">
            <a href="posts/big-picture-of-richka/" rel="bookmark">
            <time class="published dt-published" datetime="2020-05-05T17:02:40+09:00" itemprop="datePublished" title="2020-05-05 17:02">2020-05-05 17:02</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>
Posted by Hitoshi Uchida
</p>

<div id="outline-container-org8b5a51b" class="outline-2">
<h2 id="org8b5a51b">Abstract</h2>
<div class="outline-text-2" id="text-org8b5a51b">
<p>
This is the first post from our engineer team.
</p>

<p>
We periodically share technological topics such as new integrated
features into products and new technologies we are interested in and
prototype implementations to evaluate the feasibility whether they are
worth developing as actual business service.
</p>

<p>
In this post, we introduce a web application RICHKA which enables
users to easily create high quality videos on web browsers,
especially, the development environment and the server infra
structures and the processing sequence of the primary function to
generate high quality videos with using image/videos users upload. The
architecture and internal processing are generally complicated than
general services such as EC and blog and chat system because the size
of video files are huge and we need to carefully take care the load of
servers such as delegating heavy processing to other dedicated video
servers and applying delaying processing to postpone heavy processing
later. And the load of file storage is also high and we need to take
care the timing to load files from network storage. On GUI, we don't
initially load video contents because it increases the load of web
servers and delay the response and influences to UX. Instead, we load
thumbnails of any videos on GUI and load video contents only when they
are played on video player.
</p>

<p>
RICHKA has some dedicated video engines to generate high quality
videos with using well designed video templates created by expert
designers. To make the representation of videos richer, video servers
enable to change not only input texts and image/video material files
users upload, but also font family and color scheme and BGM in
realtime during generating videos. The load of video generation
processing is very heavy and we apply lots of optimization to reduce
the generation time with keeping the high quality. Therefore video
services demand higher development skills of web applications.
</p>
</div>
</div>


<div id="outline-container-orgd3591d5" class="outline-2">
<h2 id="orgd3591d5">RICHKA Development Environment</h2>
<div class="outline-text-2" id="text-orgd3591d5">
<p>
<img src="images/big-picture-of-richka/technologies-building-richka.png" alt="nil"></p>

<p>
The engineer team is basically remote and more than 90% live in
foreign countries. We hire only high skill experts who have strong
skills of web technologies and web application development. We will
describe our team more on another post later.
</p>

<p>
We always apply new emerged technologies into products to enhance the
features and reduce development cost. It is free for our engineers to
propose them to see the feasibility and the side effect. The speed of
try and error is faster than general teams because our team is
completely flat and every member has the privilege to propose new
ideas among members. If clear and reasonable purposes are explained to
the team, they are basically accepted.
</p>

<p>
Regarding server side, it is based on Python and Django and we use
additional 42 Python packages such as Django extensions and
image/video manipulation and statistics and crypt. The current total
lines of Django is around 12200.
</p>

<p>
Regarding front end, we use abut 20 OSS libraries to build the
functional GUI such as jQuery, cropper.js, smartcrop.js, Vue, Bootstrap
and so on. The current total lines of JavaScript codes we developed is
around 13000.
</p>
</div>

<div id="outline-container-org655aa24" class="outline-4">
<h4 id="org655aa24">OS</h4>
<div class="outline-text-4" id="text-org655aa24">
<p>
Ubuntu Server
</p>
</div>
</div>

<div id="outline-container-orgcf369ab" class="outline-4">
<h4 id="orgcf369ab">Programming Language</h4>
<div class="outline-text-4" id="text-orgcf369ab">
<p>
Python, JavaScript, HTML5, CSS3, JSX, Bash
</p>
</div>
</div>

<div id="outline-container-org8b7aa8a" class="outline-4">
<h4 id="org8b7aa8a">Server Side Technologies</h4>
<div class="outline-text-4" id="text-org8b7aa8a">
<p>
Django, MySQL, HTTP2, Web API, video generation engine, image processing,
multi core processing, load distribution
</p>
</div>
</div>

<div id="outline-container-org911ff3f" class="outline-4">
<h4 id="org911ff3f">Front End</h4>
<div class="outline-text-4" id="text-org911ff3f">
<p>
jQuery, jQuery UI, Vue.js, video.js, cropper.js, smartcrop.js, Bootstrap and much more
</p>
</div>
</div>

<div id="outline-container-org3820329" class="outline-4">
<h4 id="org3820329">Regression Test</h4>
<div class="outline-text-4" id="text-org3820329">
<p>
Jenkins, Django UnitTest, Selenium
</p>
</div>
</div>
</div>


<div id="outline-container-orgc9aa4cc" class="outline-2">
<h2 id="orgc9aa4cc">Sequence of video generation</h2>
<div class="outline-text-2" id="text-orgc9aa4cc">
<p>
<img src="images/big-picture-of-richka/video-generation-sequence.png" alt="nil"></p>

<p>
RICHKA is behind a load balancer to distribute lots of coming HTTP
requests to multiple web servers. And to enable simultaneous video
generation at a time, the video generation requests are also
distributed to multiple video servers. The user data such as
images/videos users upload and video template files used by video
engine are stored on an external network storage. They are retrieved
from both web servers and video servers.
</p>

<p>
The summary sequence of video generation is,
</p>

<ol class="org-ol">
<li>Users click a button to generate videos and the requests reach one of web servers via the load balancer.</li>
<li>The web server retrieves the user data such as selected video template and font families and color scheme and BGM and make HTTP requests and send to one of video servers.</li>
<li>The web server receives the generation progress in realtime and store into the database to show the progress on GUI.</li>
<li>When the generations have been done, the web server downloads the generated videos and store into the file storage.</li>
<li>The web server sends the generated videos to web browsers and video player loads them and users can see on GUI.</li>
</ol>
</div>
</div>
    </div>
    </article>
</div>







        </div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2020         <a href="mailto:">Cocktail-Make</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145253993-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-145253993-3');
</script>
</body>
</html>
